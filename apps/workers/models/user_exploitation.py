from django.db import models
from transliterate.utils import _

from apps.workers.models import UserBasic
from transliterate import translit
from django.template.defaultfilters import slugify


class ExploitationManager(models.Manager):
    def create_user(self, phone, password, **extra_fields):
        if not phone:
            raise ValueError(_('Не указан телефонный номер.'))
        user = self.model(phone=phone, **extra_fields)
        user.set_password(password)
        user.save()
        return user

    def get_queryset(self, *args, **kwargs):
        return super().get_queryset(*args, **kwargs).filter(type=UserBasic.Types.EXPLOITATION)


class Exploitation(UserBasic):
    class Meta:
        proxy = True

    objects = ExploitationManager()

    def save(self, *args, **kwargs):
        self.type = UserBasic.Types.EXPLOITATION
        return super().save(*args, **kwargs)

    class Meta:
        verbose_name = 'Пользователь. Эксплуатация.'
        verbose_name_plural = 'Пользователи. Эксплуатация.'
        ordering = ['pk']
        default_permissions = ('')

        # permissions = (
        #     ('UserExploitation_add', 'Пользователи. Эксплуатация. Добавить.'),
        #     ('UserExploitation_change', 'Пользователи. Эксплуатация. Редактировать.'),
        #     ('UserExploitation_delete', 'Пользователи. Эксплуатация. Удалить.'),
        #     ('UserExploitation_view', 'Пользователи. Эксплуатация. Просмотреть.'),
        # )


class OrganizationExploitation(models.Model):
    """Эксплуатирующие организации"""
    name = models.CharField(max_length=150, unique=True, verbose_name='Название')
    city = models.CharField(max_length=40, blank=True, unique=False, verbose_name='Город')
    inn = models.CharField(max_length=15, blank=True, unique=True, verbose_name='ИНН')
    legal_address = models.CharField(max_length=250, blank=True, unique=False, verbose_name='Юридический адрес')
    letter_address = models.CharField(max_length=250, blank=True, unique=False,
                                      verbose_name='Адрес для корреспонденции')
    website = models.URLField(max_length=150, blank=True, unique=False, verbose_name='Сайт')
    description = models.TextField(verbose_name='Описание', blank=True)
    slug = models.SlugField(max_length=100, unique=True, db_index=True, verbose_name='URL')

    def __str__(self):
        return self.name

    class Meta:
        verbose_name = 'Эксплуатирующая организация'
        verbose_name_plural = 'Эксплуатирующие организации'
        ordering = ['name']
        default_permissions = ('')
        permissions = (
            ('organizationExploitation_add', 'Эксплуатирующая организация. Добавить.'),
            ('organizationExploitation_change', 'Эксплуатирующая организация. Редактировать.'),
            ('organizationExploitation_delete', 'Эксплуатирующая организация. Удалить.'),
            ('organizationExploitation_view', 'Эксплуатирующая организация. Просмотреть.'),
        )

    def save(self, **kwargs):
        self.slug = slugify(translit(self.name, 'ru', reversed=True))
        super(OrganizationExploitation, self).save()
